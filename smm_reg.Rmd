---
title: "Maternal Morbidity Regression"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(readxl)
library(readr)
library(ggpubr)
library(corrplot)
library(RColorBrewer)
library(Hmisc)
library(patchwork)
library(rstatix)
library(glmnet)
library(MASS)

knitr::opts_chunk$set(
	fig.width = 9, 
  fig.asp = .6,
  out.width = "90%",
	warning = FALSE,
	message = FALSE
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

#### Linear Regression Model

Let's start by fitting a linear model to the severe maternal morbidity outcome using our stepwise AIC automatic feature selection algorithm. Next, we'll take a look at the chosen predictors, effect measures, and run regression diagnostics. 
```{r}
#Combined predictors with SMM outcome
predictor_df = read.csv("./data/predictors.csv")
outcome_df = read.csv("./data/outcomes.csv")
smm_linear_df = predictor_df %>% 
  mutate(smm = outcome_df$smm)

#Fit the full model 
full_smm_linear.model <- lm(smm~., data = smm_linear_df)
#Stepwise regression model
step_smm_linear.model <- stepAIC(full_smm_linear.model, direction = "both", 
                      trace = FALSE)

#Display converged model
step_smm_linear.model %>% 
  broom::tidy() %>%
  knitr::kable(digits = 3)
```

The variables female, hispanic, white, black, foreign_born, limited_eng, education, unemployment, late_no_prenatal_care, and clinics_and_chc_density were chosen in the final model. The model has an R-squared value of `summary(step_smm_linear.model)$r.squared`, representing a reasonably good fit. 

However, we were concerned about our assumptions for linear regression, so they need to be 
checked before we can interpret any results. 

```{r}
#Regression diagnostics
plot(step_smm_linear.model)

#Shapiro test
smm_linear_shapiro = shapiro.test(residuals(step_smm_linear.model))
```
The Normal Q-Q plot has fat tails, suggesting violation of the normality assumption. This is confirmed with the Shapiro-Wilk test for normality, which has a p-value of `smm_linear_shapiro$p.value`. The plot of residuals vs fitted values is non-random, suggesting a violation of the homoskedasticity assumption, also indicated by the scale-location plot, where the line is not straight. 

We'll stop this analysis here since it's clear the model doesn't follow linear assumptions.

#### Transformed Regression Model


```{r}

```
